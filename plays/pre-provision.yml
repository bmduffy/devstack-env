---
- name: Pre-provisioning configuration on host

  hosts: 127.0.0.1
  connection: local

  vars:

    ip:   "{{ lookup('env', 'VD_ENV_GUEST_IP')        }}"
    key:  "{{ lookup('env', 'VD_ENV_DEFAULT_RSA_KEY') }}"
    host: "{{ lookup('env', 'VD_ENV_HOSTNAME')        }}"

    user:      "{{ lookup('env', 'USER') }}"
    workspace: "{{ lookup('env', 'VD_ENV_WORKSPACE') }}"

  tasks: 

    - name: Create .env file for Vagrant 
      file: path="{{ workspace }}/.env"
            state=touch
      become: yes
      become_user: "{{ user }}"
    
    - name: Configure .env file for Vagrant
      blockinfile:
        dest: "{{ workspace }}/.env"
        block: |
          GUEST_IP={{ ip }}

    - name: "Create directories" 
      file: path="{{ workspace }}/{{ item }}"
            state=directory
      with_items:
        - devstack
        - src
      become: yes
      become_user: "{{ user }}"

    - name: "Unmount devstack"
      shell: "fusermount -z -u {{ item.mount }}"
      with_items: "{{ ansible_mounts }}"
      when: item.mount == "{{ workspace }}/devstack"
      become: yes
      become_user: root

    - name: "Unmount src"
      shell: "fusermount -z -u {{ item.mount }}"
      with_items: "{{ ansible_mounts }}"
      when: item.mount == "{{ workspace }}/src" 
      become: yes
      become_user: root

    - name: Install relevant packages on host
      yum: name={{ item }} state=present
      with_items:
        - sudo
        - sshfs
      become: yes
      become_user: root